{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-3">
            <div class="list-group">
                <a href="#profile" class="list-group-item list-group-item-action active" data-bs-toggle="list">Profile</a>
                <a href="#security" class="list-group-item list-group-item-action" data-bs-toggle="list">Security</a>
                <a href="#notifications" class="list-group-item list-group-item-action" data-bs-toggle="list">Notifications</a>
                <a href="#gmail" class="list-group-item list-group-item-action" data-bs-toggle="list">
                    <i class="fab fa-google"></i> Gmail Integration
                </a>
            </div>
        </div>
        
        <div class="col-md-9">
            <!-- Profile Settings -->
            <div class="tab-pane fade show active" id="profile">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Profile Information</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('update_profile') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" value="{{ user.email }}" disabled>
                            </div>
                            
                            <div class="mb-3">
                                <label for="full_name" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="full_name" name="full_name" value="{{ user.full_name or '' }}">
                            </div>
                            
                            <div class="mb-3">
                                <label for="theme" class="form-label">Theme</label>
                                <select class="form-select" id="theme" name="theme">
                                    <option value="light" {% if user.theme == 'light' %}selected{% endif %}>Light</option>
                                    <option value="dark" {% if user.theme == 'dark' %}selected{% endif %}>Dark</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="email_notifications" name="email_notifications" 
                                           {% if user.email_notifications %}checked{% endif %}>
                                    <label class="form-check-label" for="email_notifications">Email Notifications</label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="in_app_notifications" name="in_app_notifications" 
                                           {% if user.in_app_notifications %}checked{% endif %}>
                                    <label class="form-check-label" for="in_app_notifications">In-App Notifications</label>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Security Settings -->
            <div class="tab-pane fade" id="security">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Change Password</h5>
                    </div>
                    <div class="card-body">
                        <a href="{{ url_for('change_password') }}" class="btn btn-primary">Change Password</a>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Two-Factor Authentication</h5>
                    </div>
                    <div class="card-body">
                        {% if user.two_factor_enabled %}
                        <p class="text-success"><i class="bi bi-check-circle"></i> Two-factor authentication is enabled</p>
                        <p class="text-muted">Your account is protected with 2FA using TOTP.</p>
                        <form method="POST" action="{{ url_for('disable_2fa') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Are you sure?')">Disable 2FA</button>
                        </form>
                        {% else %}
                        <p class="text-warning"><i class="bi bi-exclamation-triangle"></i> Two-factor authentication is not enabled</p>
                        <p>Secure your account with two-factor authentication.</p>
                        <a href="{{ url_for('setup_2fa') }}" class="btn btn-primary">Enable 2FA</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Notification Settings -->
            <div class="tab-pane fade" id="notifications">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Notification Preferences</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Configure how you receive notifications</p>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="email_notif" {% if user.email_notifications %}checked{% endif %}>
                            <label class="form-check-label" for="email_notif">
                                Receive email notifications for important events
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="inapp_notif" {% if user.in_app_notifications %}checked{% endif %}>
                            <label class="form-check-label" for="inapp_notif">
                                Receive in-app notifications
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gmail Integration Settings -->
            <div class="tab-pane fade" id="gmail">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fab fa-google"></i> Gmail Integration</h5>
                    </div>
                    <div class="card-body">
                        {% if user.gmail_connected %}
                        <div class="alert alert-success" role="alert">
                            <i class="fas fa-check-circle"></i>
                            <strong>Gmail Connected!</strong>
                            Connected since {{ user.gmail_connected_at.strftime('%Y-%m-%d %H:%M') }}
                        </div>
                        
                        <p class="text-muted mb-3">Your Gmail account is successfully connected. You can now sync emails as documents.</p>
                        
                        <div class="btn-group mb-3" role="group">
                            <a href="{{ url_for('gmail_configure') }}" class="btn btn-primary">
                                <i class="fas fa-cogs"></i> Configure Sync
                            </a>
                            <button type="button" class="btn btn-outline-secondary" onclick="manualSync()">
                                <i class="fas fa-sync"></i> Sync Now
                            </button>
                        </div>
                        
                        <hr>
                        
                        <h6>Disconnect Gmail?</h6>
                        <p class="text-muted small">Disconnecting will stop syncing new emails. Existing synced documents will remain.</p>
                        <button type="button" class="btn btn-outline-danger" onclick="disconnectConfirm()">
                            <i class="fas fa-sign-out-alt"></i> Disconnect Gmail
                        </button>
                        
                        {% else %}
                        <div class="alert alert-info" role="alert">
                            <i class="fas fa-info-circle"></i>
                            <strong>Gmail not connected</strong>
                        </div>
                        
                        <p class="text-muted mb-3">Connect your Gmail account to automatically sync emails as documents.</p>
                        
                        <a href="{{ url_for('gmail_setup') }}" class="btn btn-primary">
                            <i class="fab fa-google"></i> Connect Gmail
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function manualSync() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
    
    fetch('{{ url_for("gmail_sync") }}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        },
        body: new FormData()
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(`✅ Sync complete!\nCreated: ${data.created} documents\nUpdated: ${data.updated}`);
            btn.disabled = false;
            btn.innerHTML = originalText;
        } else {
            alert('❌ ' + data.error);
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    })
    .catch(e => {
        alert('❌ Error: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

function disconnectConfirm() {
    if (!confirm('Are you sure you want to disconnect Gmail? Existing synced documents will remain.')) {
        return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Disconnecting...';
    
    fetch('{{ url_for("gmail_disconnect") }}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('✅ Gmail disconnected');
            location.reload();
        } else {
            alert('❌ ' + data.error);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Disconnect Gmail';
        }
    })
    .catch(e => {
        alert('❌ Error: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Disconnect Gmail';
    });
}

.fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</script>
{% endblock %}
